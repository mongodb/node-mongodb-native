description: run some cursor commands

schemaVersion: "1.0"

runOnRequirements: {}

createEntities:
  - client:
      id: &client0 client0
      observeEvents: [commandStartedEvent]
  - database:
      id: &database0 database0
      client: *client0
      databaseName: &database0Name database0
  - collection:
      id: collection0
      database: *database0
      collectionName: &collection0Name collection0
  - session:
      id: &session0 session0
      client: *client0

initialData:
  - collectionName: *collection0Name
    databaseName: *database0Name
    documents:
      - { _id: 0, x: 20 }
      - { _id: 1, x: 21 }
      - { _id: 2, x: 22 }

tests:
  - description: a find is run by runCursorCommand
    operations:
      - name: runCursorCommand
        object: *database0
        arguments:
          commandName: find
          command:
            find: *collection0Name
            batchSize: 1
          comment: 'manually running a find'
        saveResultAsEntity: &manualFindCursor manualFindCursor
      - name: iterateUntilDocumentOrError
        object: *manualFindCursor
        expectResult:
          _id: 0
          x: 20
      - name: iterateUntilDocumentOrError
        object: *manualFindCursor
        expectResult:
          _id: 1
          x: 21
      - name: iterateUntilDocumentOrError
        object: *manualFindCursor
        expectResult:
          _id: 2
          x: 22
      - name: iterateUntilDocumentOrError
        object: *manualFindCursor
        expectResult: null
      - name: iterateUntilDocumentOrError
        object: *manualFindCursor
        expectError:
          isClientError: true
    expectEvents:
      - client: *client0
        events:
        - commandStartedEvent:
              command:
                find: *collection0Name
                $db: *database0Name
                comment: { $$exists: false }
                lsid: { id: { $$type: 'binData' } }
                batchSize: 1
                $clusterTime: { $$exists: false }
              commandName: find
        - commandStartedEvent:
              command:
                getMore: { $$type: 'long' }
                collection: *collection0Name
                comment: 'manually running a find'
                $db: *database0Name
                lsid: { id: { $$type: 'binData' } }
                $clusterTime: { $$exists: false }
              commandName: getMore
