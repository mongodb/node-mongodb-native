description: backpressure-network-error-fail
schemaVersion: "1.17"
runOnRequirements:
  - minServerVersion: "4.4"
    serverless: forbid
    topologies:
      - single
      - replicaset
      - sharded
createEntities:
  - client:
      id: setupClient
      useMultipleMongoses: false
initialData:
  - collectionName: backpressure-network-error-fail
    databaseName: sdam-tests
    documents:
      - _id: 1
      - _id: 2
tests:
  - description: apply backpressure on network connection errors during connection establishment
    operations:
      - name: createEntities
        object: testRunner
        arguments:
          entities:
            - client:
                id: client
                useMultipleMongoses: false
                observeEvents:
                  - serverHeartbeatSucceededEvent
                  - poolClearedEvent
                uriOptions:
                  retryWrites: false
                  heartbeatFrequencyMS: 1000000
                  serverMonitoringMode: poll
                  appname: backpressureNetworkErrorFailTest
            - database:
                id: database
                client: client
                databaseName: sdam-tests
            - collection:
                id: collection
                database: database
                collectionName: backpressure-network-error-fail
      - name: waitForEvent
        object: testRunner
        arguments:
          client: client
          event:
            serverHeartbeatSucceededEvent: {}
          count: 1
      - name: failPoint
        object: testRunner
        arguments:
          client: setupClient
          failPoint:
            configureFailPoint: failCommand
            mode: alwaysOn
            data:
              failCommands:
                - isMaster
                - hello
              appName: backpressureNetworkErrorFailTest
              closeConnection: true
      - name: insertMany
        object: collection
        arguments:
          documents:
            - _id: 3
            - _id: 4
        expectError:
          isError: true
          errorLabelsContain:
            - SystemOverloadedError
            - RetryableError
    expectEvents:
      - client: client
        eventType: cmap
        events: []
